{% extends "base.html" %}

{% block title %}Backup & Restore - FFGSA_CSM{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-cloud-upload"></i> Backup & Restore</h1>
            <p class="text-muted">Manage system backups and restore operations</p>
        </div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBackupModal">
            <i class="bi bi-plus-circle"></i> Create Backup
        </button>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Total Backups</h6>
                            <h2 class="mb-0">{{ stats.total_backups or 0 }}</h2>
                        </div>
                        <i class="bi bi-archive display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Database</h6>
                            <h2 class="mb-0">{{ stats.database_backups or 0 }}</h2>
                        </div>
                        <i class="bi bi-database display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Videos</h6>
                            <h2 class="mb-0">{{ stats.video_backups or 0 }}</h2>
                        </div>
                        <i class="bi bi-film display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Total Size</h6>
                            <h2 class="mb-0">{{ (stats.total_size / (1024*1024*1024))|round(2) }} GB</h2>
                        </div>
                        <i class="bi bi-hdd display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Progress Bar -->
    <div id="backupProgressContainer" class="card mb-4 d-none">
        <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-hourglass-split"></i> <span id="backupStatusTitle">Creating Backup...</span></h5>
            <div class="progress mb-3" style="height: 30px;">
                <div id="backupProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%">
                    <span id="backupProgressText">Initializing...</span>
                </div>
            </div>
            <div id="backupStatusMessages" class="small text-muted">
                <div id="backupStatusList"></div>
            </div>
            <div id="backupErrorMessages" class="alert alert-danger d-none mt-3">
                <strong><i class="bi bi-exclamation-triangle"></i> Errors:</strong>
                <ul id="backupErrorList" class="mb-0 mt-2"></ul>
            </div>
        </div>
    </div>

    <!-- Backup Management Actions -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-gear"></i> Backup Management</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin.cleanup_backups') }}" class="d-inline" 
                  onsubmit="return confirm('Delete backups older than the retention period?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label for="retention_days" class="form-label">Retention Period (days)</label>
                        <input type="number" class="form-control" id="retention_days" name="retention_days" 
                               value="{{ config.BACKUP_RETENTION_DAYS }}" min="1" max="365">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-trash"></i> Clean Up Old Backups
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Backups Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list"></i> Available Backups</h5>
        </div>
        <div class="card-body">
            {% if backups %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Timestamp</th>
                            <th>Description</th>
                            <th>Size</th>
                            <th>Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for backup in backups %}
                        <tr>
                            <td>
                                {% if backup.type == 'database' %}
                                <span class="badge bg-info"><i class="bi bi-database"></i> Database</span>
                                {% elif backup.type == 'videos' %}
                                <span class="badge bg-success"><i class="bi bi-film"></i> Videos</span>
                                {% elif backup.type == 'config' %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-gear"></i> Config</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ backup.timestamp[:8] }}</small><br>
                                <small class="text-muted">{{ backup.timestamp[9:] }}</small>
                            </td>
                            <td>{{ backup.description or '-' }}</td>
                            <td>{{ (backup.size / (1024*1024))|round(2) }} MB</td>
                            <td>
                                <small>
                                    {% if backup.type == 'videos' %}
                                    Videos: {{ backup.video_count or 0 }}<br>
                                    Thumbnails: {{ backup.thumbnail_count or 0 }}
                                    {% elif backup.type == 'database' %}
                                    Type: {{ backup.type }}<br>
                                    {% if backup.database %}DB: {{ backup.database }}{% endif %}
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('admin.download_backup', backup_type=backup.type, timestamp=backup.timestamp) }}" 
                                       class="btn btn-sm btn-outline-primary" title="Download">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% if backup.type in ['database', 'videos'] %}
                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#restoreModal{{ backup.timestamp }}"
                                            title="Restore">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#deleteModal{{ backup.timestamp }}"
                                            title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No backups found. Create your first backup to get started.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.create_backup') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Create Backup</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="backup_type" class="form-label">Backup Type</label>
                        <select class="form-select" id="backup_type" name="backup_type" required>
                            <option value="full">Full Backup (Database + Videos + Config)</option>
                            <option value="database">Database Only</option>
                            <option value="videos">Videos Only</option>
                            <option value="config">Configuration Only</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="e.g., Before major update, End of month backup, etc."></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Note:</strong> Backup process may take several minutes depending on data size.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-cloud-upload"></i> Create Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Restore Modals (one per backup) -->
{% for backup in backups %}
{% if backup.type in ['database', 'videos'] %}
<div class="modal fade" id="restoreModal{{ backup.timestamp }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.restore_backup') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="backup_timestamp" value="{{ backup.timestamp }}"/>
                <input type="hidden" name="backup_type" value="{{ backup.type }}"/>
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Restore Backup</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong><i class="bi bi-exclamation-triangle-fill"></i> Warning:</strong>
                        <p class="mb-0">Restoring will <strong>overwrite</strong> current data!</p>
                    </div>
                    <p>Restore <strong>{{ backup.type }}</strong> backup from:</p>
                    <ul>
                        <li><strong>Timestamp:</strong> {{ backup.timestamp }}</li>
                        <li><strong>Size:</strong> {{ (backup.size / (1024*1024))|round(2) }} MB</li>
                        {% if backup.description %}<li><strong>Description:</strong> {{ backup.description }}</li>{% endif %}
                    </ul>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="verify_checksum" value="true" checked id="verify{{ backup.timestamp }}">
                        <label class="form-check-label" for="verify{{ backup.timestamp }}">
                            Verify backup integrity (checksum)
                        </label>
                    </div>
                    {% if backup.type == 'database' %}
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> Database restore will require application restart.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-clockwise"></i> Restore Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Delete Modals (one per backup) -->
{% for backup in backups %}
<div class="modal fade" id="deleteModal{{ backup.timestamp }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.delete_backup') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="backup_timestamp" value="{{ backup.timestamp }}"/>
                <input type="hidden" name="backup_type" value="{{ backup.type }}"/>
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-trash"></i> Delete Backup</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this backup?</p>
                    <ul>
                        <li><strong>Type:</strong> {{ backup.type }}</li>
                        <li><strong>Timestamp:</strong> {{ backup.timestamp }}</li>
                        <li><strong>Size:</strong> {{ (backup.size / (1024*1024))|round(2) }} MB</li>
                    </ul>
                    <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
<script>
// Backup Progress Tracking
document.addEventListener('DOMContentLoaded', function() {
    const createBackupForm = document.querySelector('#createBackupModal form');
    
    if (createBackupForm) {
        createBackupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const backupType = formData.get('backup_type');
            const description = formData.get('description');
            const csrfToken = formData.get('csrf_token');
            
            // Hide modal and show progress
            const modal = bootstrap.Modal.getInstance(document.getElementById('createBackupModal'));
            modal.hide();
            
            showBackupProgress();
            
            // Start backup via AJAX
            startBackup(backupType, description, csrfToken);
        });
    }
});

function showBackupProgress() {
    const container = document.getElementById('backupProgressContainer');
    container.classList.remove('d-none');
    
    // Scroll to progress
    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Reset progress
    updateProgress(0, 'Initializing backup...');
    document.getElementById('backupStatusList').innerHTML = '';
    document.getElementById('backupErrorMessages').classList.add('d-none');
    document.getElementById('backupErrorList').innerHTML = '';
}

function updateProgress(percentage, message, isError = false) {
    const progressBar = document.getElementById('backupProgressBar');
    const progressText = document.getElementById('backupProgressText');
    const statusList = document.getElementById('backupStatusList');
    
    progressBar.style.width = percentage + '%';
    progressText.textContent = percentage + '%';
    
    if (percentage >= 100) {
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
    }
    
    // Add status message
    if (message) {
        const statusItem = document.createElement('div');
        statusItem.className = 'mb-1';
        statusItem.innerHTML = `<i class="bi ${isError ? 'bi-x-circle text-danger' : 'bi-check-circle text-success'}"></i> ${message}`;
        statusList.appendChild(statusItem);
    }
}

function addError(errorMessage) {
    const errorContainer = document.getElementById('backupErrorMessages');
    const errorList = document.getElementById('backupErrorList');
    
    errorContainer.classList.remove('d-none');
    
    const errorItem = document.createElement('li');
    errorItem.textContent = errorMessage;
    errorList.appendChild(errorItem);
}

function startBackup(backupType, description, csrfToken) {
    updateProgress(10, 'Starting backup process...');
    
    const data = {
        backup_type: backupType,
        description: description || ''
    };
    
    fetch('{{ url_for("api.trigger_backup") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success || result.success === undefined) {
            // Full backup
            if (backupType === 'full') {
                let progress = 30;
                
                if (result.backups.database) {
                    updateProgress(progress, `✓ Database backup completed (${(result.backups.database.size / (1024*1024)).toFixed(2)} MB)`);
                    progress += 30;
                } else if (result.errors && result.errors.some(e => e.includes('Database'))) {
                    addError('Database backup failed');
                }
                
                if (result.backups.videos) {
                    updateProgress(progress, `✓ Video files backup completed (${(result.backups.videos.size / (1024*1024)).toFixed(2)} MB)`);
                    progress += 30;
                } else if (result.errors && result.errors.some(e => e.includes('Video'))) {
                    addError('Video backup failed');
                }
                
                if (result.backups.config) {
                    updateProgress(progress, `✓ Configuration backup completed`);
                    progress += 10;
                } else if (result.errors && result.errors.some(e => e.includes('Config'))) {
                    addError('Configuration backup failed');
                }
                
                updateProgress(100, result.errors && result.errors.length > 0 ? 
                    'Backup completed with errors' : 'Full backup completed successfully!');
                
                // Show errors if any
                if (result.errors && result.errors.length > 0) {
                    result.errors.forEach(err => addError(err));
                }
            } 
            // Single backup type
            else {
                updateProgress(50, `Processing ${backupType} backup...`);
                
                if (result.type) {
                    const size = (result.size / (1024*1024)).toFixed(2);
                    updateProgress(100, `✓ ${capitalize(result.type)} backup completed (${size} MB)`);
                } else {
                    updateProgress(100, 'Backup completed successfully!');
                }
            }
            
            // Reload page after delay
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            updateProgress(100, 'Backup failed!', true);
            addError(result.error || 'Unknown error occurred');
            document.getElementById('backupProgressBar').classList.remove('progress-bar-animated');
            document.getElementById('backupProgressBar').classList.add('bg-danger');
        }
    })
    .catch(error => {
        console.error('Backup error:', error);
        updateProgress(100, 'Backup failed!', true);
        addError('Network error: ' + error.message);
        document.getElementById('backupProgressBar').classList.remove('progress-bar-animated');
        document.getElementById('backupProgressBar').classList.add('bg-danger');
    });
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}
</script>
{% endblock %}

